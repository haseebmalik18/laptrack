{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/haseebulhaqmalik/Desktop/lap-lens/web/app/traces/components/MiniTrackMap.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useRef, useMemo, useCallback } from \"react\";\n\ninterface MiniTrackMapProps {\n  lapData: any;\n  referenceLapData: any;\n  corners: any[];\n  hoveredDistance?: number | null;\n}\n\nexport function MiniTrackMap({ lapData, referenceLapData, corners, hoveredDistance }: MiniTrackMapProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const animationFrameRef = useRef<number>();\n  const fullTelemetryRef = useRef<any[]>([]);\n  const lastDrawnDistance = useRef<number | null>(null);\n\n  const { normalizedPoints, bounds } = useMemo(() => {\n    if (!lapData?.telemetry) return { normalizedPoints: [], bounds: { minX: 0, maxX: 0, minY: 0, maxY: 0 } };\n\n    const telemetry = lapData.telemetry;\n\n    // Store full telemetry with rotation for hover lookup\n    const fullRotated = telemetry.map((p: any) => ({\n      ...p,\n      x: -p.x,\n      y: -p.y\n    }));\n    fullTelemetryRef.current = fullRotated;\n\n    // Sample every 20 points for much faster rendering (reduces ~5000 points to ~250)\n    const sampledTelemetry = telemetry.filter((_: any, i: number) => i % 20 === 0);\n\n    // Rotate sampled points\n    const rotatedPoints = sampledTelemetry.map((p: any) => ({\n      ...p,\n      x: -p.x,\n      y: -p.y\n    }));\n\n    const xs = rotatedPoints.map((p: any) => p.x);\n    const ys = rotatedPoints.map((p: any) => p.y);\n\n    const minX = Math.min(...xs);\n    const maxX = Math.max(...xs);\n    const minY = Math.min(...ys);\n    const maxY = Math.max(...ys);\n\n    return {\n      normalizedPoints: rotatedPoints,\n      bounds: { minX, maxX, minY, maxY }\n    };\n  }, [lapData]);\n\n  const draw = useCallback(() => {\n    const canvas = canvasRef.current;\n    if (!canvas || normalizedPoints.length === 0) return;\n\n    // Skip redraw if distance hasn't changed\n    if (lastDrawnDistance.current === hoveredDistance && hoveredDistance !== null) {\n      return;\n    }\n    lastDrawnDistance.current = hoveredDistance;\n\n    const ctx = canvas.getContext(\"2d\", {\n      alpha: false,\n      desynchronized: true // Better performance\n    });\n    if (!ctx) return;\n\n    const width = canvas.width;\n    const height = canvas.height;\n\n    // Clear canvas\n    ctx.fillStyle = \"#09090b\";\n    ctx.fillRect(0, 0, width, height);\n\n    const padding = 30;\n    const drawWidth = width - padding * 2;\n    const drawHeight = height - padding * 2;\n\n    const { minX, maxX, minY, maxY } = bounds;\n    const rangeX = maxX - minX;\n    const rangeY = maxY - minY;\n\n    // Scale to fit canvas (maintain aspect ratio)\n    const scaleX = drawWidth / rangeX;\n    const scaleY = drawHeight / rangeY;\n    const scale = Math.min(scaleX, scaleY);\n\n    // Center the track\n    const offsetX = padding + (drawWidth - rangeX * scale) / 2;\n    const offsetY = padding + (drawHeight - rangeY * scale) / 2;\n\n    const toCanvasX = (x: number) => offsetX + (x - minX) * scale;\n    const toCanvasY = (y: number) => height - (offsetY + (y - minY) * scale);\n\n    // Draw racing line (current lap only) - simplified rendering\n    ctx.strokeStyle = \"#facc15\";\n    ctx.lineWidth = 2.5;\n    ctx.lineCap = \"round\";\n    ctx.lineJoin = \"round\";\n    ctx.beginPath();\n    for (let i = 0; i < normalizedPoints.length; i++) {\n      const point = normalizedPoints[i];\n      const x = toCanvasX(point.x);\n      const y = toCanvasY(point.y);\n      if (i === 0) ctx.moveTo(x, y);\n      else ctx.lineTo(x, y);\n    }\n    ctx.stroke();\n\n    // Draw corner markers\n    if (corners && corners.length > 0) {\n      corners.forEach((corner: any) => {\n        if (!corner || corner.apexDistance === undefined || corner.cornerNumber === undefined) return;\n\n        const apexPoint = normalizedPoints.find(\n          (p: any) => Math.abs(p.distance - corner.apexDistance) < 5\n        );\n        if (apexPoint) {\n          const x = toCanvasX(apexPoint.x);\n          const y = toCanvasY(apexPoint.y);\n\n          // Corner dot\n          ctx.fillStyle = \"#ef4444\";\n          ctx.beginPath();\n          ctx.arc(x, y, 4, 0, Math.PI * 2);\n          ctx.fill();\n\n          // Corner number\n          ctx.fillStyle = \"#fff\";\n          ctx.font = \"10px monospace\";\n          ctx.textAlign = \"center\";\n          ctx.fillText(String(corner.cornerNumber), x, y - 8);\n        }\n      });\n    }\n\n    // Draw start/finish line\n    const startPoint = normalizedPoints[0];\n    if (startPoint) {\n      const x = toCanvasX(startPoint.x);\n      const y = toCanvasY(startPoint.y);\n\n      ctx.strokeStyle = \"#22c55e\";\n      ctx.lineWidth = 3;\n      ctx.beginPath();\n      ctx.moveTo(x - 6, y - 6);\n      ctx.lineTo(x + 6, y + 6);\n      ctx.moveTo(x - 6, y + 6);\n      ctx.lineTo(x + 6, y - 6);\n      ctx.stroke();\n    }\n\n    // Draw hovered position marker (use full telemetry for accuracy)\n    if (hoveredDistance !== null && hoveredDistance !== undefined && fullTelemetryRef.current.length > 0) {\n      // Fast lookup - since distance is sequential, we can estimate the index\n      const maxDist = fullTelemetryRef.current[fullTelemetryRef.current.length - 1].distance;\n      const estimatedIndex = Math.floor((hoveredDistance / maxDist) * fullTelemetryRef.current.length);\n\n      let closestPoint = null;\n      let minDiff = Infinity;\n\n      // Search around estimated position (much faster than full search)\n      const searchRange = 100;\n      const start = Math.max(0, estimatedIndex - searchRange);\n      const end = Math.min(fullTelemetryRef.current.length, estimatedIndex + searchRange);\n\n      for (let i = start; i < end; i++) {\n        const p = fullTelemetryRef.current[i];\n        const diff = Math.abs(p.distance - hoveredDistance);\n        if (diff < minDiff) {\n          minDiff = diff;\n          closestPoint = p;\n        }\n      }\n\n      if (closestPoint) {\n        const x = toCanvasX(closestPoint.x);\n        const y = toCanvasY(closestPoint.y);\n\n        // Simple circle marker\n        ctx.fillStyle = \"#3b82f6\";\n        ctx.beginPath();\n        ctx.arc(x, y, 7, 0, Math.PI * 2);\n        ctx.fill();\n\n        // Outer glow\n        ctx.strokeStyle = \"#60a5fa\";\n        ctx.lineWidth = 2;\n        ctx.stroke();\n\n        // Distance label\n        ctx.fillStyle = \"#fff\";\n        ctx.font = \"bold 10px monospace\";\n        ctx.textAlign = \"center\";\n        ctx.fillText(`${Math.round(hoveredDistance)}m`, x, y - 13);\n      }\n    }\n  }, [normalizedPoints, bounds, corners, referenceLapData, hoveredDistance]);\n\n  useEffect(() => {\n    // Cancel any pending animation frame\n    if (animationFrameRef.current) {\n      cancelAnimationFrame(animationFrameRef.current);\n    }\n\n    // Schedule the draw on next animation frame\n    animationFrameRef.current = requestAnimationFrame(draw);\n\n    return () => {\n      if (animationFrameRef.current) {\n        cancelAnimationFrame(animationFrameRef.current);\n      }\n    };\n  }, [draw]);\n\n  return (\n    <div className=\"bg-black border border-zinc-800\">\n      <div className=\"border-b border-zinc-800 px-4 py-2\">\n        <h3 className=\"text-xs font-semibold text-white uppercase tracking-wider\">\n          Track Map\n        </h3>\n      </div>\n      <div className=\"p-4\">\n        <canvas\n          ref={canvasRef}\n          width={400}\n          height={400}\n          className=\"w-full h-auto\"\n        />\n        <div className=\"mt-3 flex items-center justify-between text-[10px]\">\n          <div className=\"flex items-center gap-1.5\">\n            <div className=\"w-3 h-0.5 bg-yellow-400\"></div>\n            <span className=\"text-zinc-400\">Lap {lapData?.metadata?.lapNumber || \"?\"}</span>\n          </div>\n          <div className=\"flex items-center gap-1.5\">\n            <div className=\"w-2 h-2 rounded-full bg-red-500\"></div>\n            <span className=\"text-zinc-400\">Corners</span>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}}]
}