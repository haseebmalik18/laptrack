{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/haseebulhaqmalik/Desktop/lap-lens/web/app/api/insights/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport path from 'path';\nimport fs from 'fs';\nimport { execSync } from 'child_process';\n\nexport async function GET(request: Request) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const currentLap = searchParams.get('current');\n    const referenceLap = searchParams.get('reference');\n\n    if (!currentLap || !referenceLap) {\n      return NextResponse.json(\n        { error: 'Missing lap parameters' },\n        { status: 400 }\n      );\n    }\n\n    const lapsDir = path.join(process.cwd(), '..', 'laps');\n    const cornersDir = path.join(process.cwd(), '..', 'corners');\n\n    // Get track name from lap metadata\n    const lapFiles = fs.readdirSync(lapsDir).filter(f => f.startsWith(`lap_${currentLap}_`) && f.endsWith('.json'));\n    if (lapFiles.length === 0) {\n      return NextResponse.json({ error: 'Lap not found' }, { status: 404 });\n    }\n\n    const lapMetadata = JSON.parse(fs.readFileSync(path.join(lapsDir, lapFiles[0]), 'utf-8'));\n    const trackName = lapMetadata.trackName;\n    const match = trackName.match(/\\(([^)]+)\\)/);\n    const simpleName = match ? match[1].toLowerCase() : trackName.toLowerCase();\n\n    // Load corners database\n    const cornerDbPath = path.join(cornersDir, `${simpleName}.json`);\n    if (!fs.existsSync(cornerDbPath)) {\n      return NextResponse.json({ error: 'Corner database not found' }, { status: 404 });\n    }\n\n    const cornerDb = JSON.parse(fs.readFileSync(cornerDbPath, 'utf-8'));\n    const corners = cornerDb.corners;\n\n    // Run the actual G-force comparison analysis\n    const projectRoot = path.join(process.cwd(), '..');\n    const analysisCmd = `cd \"${projectRoot}\" && npx tsx src/compare-gforce.ts ${currentLap} ${referenceLap} --json`;\n\n    let analysisResult;\n    try {\n      const output = execSync(analysisCmd, { encoding: 'utf-8', maxBuffer: 10 * 1024 * 1024 });\n      // Extract JSON from output (it may have other console logs)\n      const jsonMatch = output.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        analysisResult = JSON.parse(jsonMatch[0]);\n      } else {\n        throw new Error('No JSON output from analysis');\n      }\n    } catch (execError) {\n      console.error('Failed to run analysis:', execError);\n      return NextResponse.json({ error: 'Analysis failed', details: String(execError) }, { status: 500 });\n    }\n\n    // Transform G-force analysis insights into UI-friendly format\n    const insights = analysisResult.corners\n      ?.filter((corner: any) => corner.insight && corner.insight.type !== 'neutral' && corner.insight.type !== 'faster-overall')\n      .map((corner: any) => {\n        const insight = corner.insight;\n        const cornerData = corners.find((c: any) => c.cornerNumber === corner.cornerNumber);\n\n        // Determine improvement type and generate concise messages\n        let type = 'apex';\n        let title = '';\n        let description = '';\n\n        switch (insight.type) {\n          case 'under-braking':\n            type = 'braking';\n            title = 'Brake Later';\n            const speedLoss = Math.abs(corner.apexSpeed?.delta || 0);\n            description = `${speedLoss.toFixed(0)} km/h slow at apex. Brake later.`;\n            break;\n\n          case 'over-braking':\n            type = 'braking';\n            title = 'Braking Too Early';\n            description = 'Braking too early. Brake closer to corner.';\n            break;\n\n          case 'not-using-grip':\n            type = 'apex';\n            title = 'More Grip Available';\n            const gDelta = Math.abs(corner.peakLateralG?.delta || 0);\n            description = `${gDelta.toFixed(1)}G unused. Push harder.`;\n            break;\n\n          case 'better-previous-corner':\n            type = 'apex';\n            title = 'Better Entry';\n            description = `Faster entry. Good adaptation.`;\n            break;\n\n          default:\n            type = 'apex';\n            title = 'Slower';\n            description = insight.message || 'Check this corner.';\n        }\n\n        // Calculate time gain\n        const timeDelta = (corner.exitDistance - corner.entryDistance) || 100;\n        const currentTime = timeDelta / Math.max(corner.apexSpeed?.lapA || 100, 1);\n        const refTime = timeDelta / Math.max(corner.apexSpeed?.lapB || 100, 1);\n        const potentialGain = Math.abs(currentTime - refTime);\n\n        return {\n          corner: corner.cornerNumber,\n          distance: corner.apexDistance,\n          brakingDistance: cornerData?.brakingZone?.entryDistance || corner.entryDistance,\n          type,\n          title,\n          description,\n          potentialGain: `${potentialGain.toFixed(2)}s`,\n          confidence: insight.confidence || 'medium',\n        };\n      }) || [];\n\n    return NextResponse.json({ insights });\n  } catch (error) {\n    console.error('Error generating insights:', error);\n    return NextResponse.json(\n      { error: 'Failed to generate insights', details: String(error) },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}