{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/haseebulhaqmalik/Desktop/lap-lens/web/app/api/sectors/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport path from 'path';\nimport fs from 'fs';\nimport { LapLoader } from '../../../../../src/analysis/lap-loader';\nimport { LapNormalizer } from '../../../../../src/analysis/lap-normalizer';\nimport { LapAligner } from '../../../../../src/analysis/lap-aligner';\nimport { SectorAnalyzer } from '../../../../../src/analysis/sector-analysis';\n\nexport async function GET(request: Request) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const currentLap = searchParams.get('current');\n    const referenceLap = searchParams.get('reference');\n\n    if (!currentLap || !referenceLap) {\n      return NextResponse.json(\n        { error: 'Missing lap parameters' },\n        { status: 400 }\n      );\n    }\n\n    const lapsDir = path.join(process.cwd(), '..', 'laps');\n    const cornersDir = path.join(process.cwd(), '..', 'corners');\n\n    const loader = new LapLoader(lapsDir);\n    const normalizer = new LapNormalizer({ sampleRate: 1.0 });\n    const aligner = new LapAligner();\n    const sectorAnalyzer = new SectorAnalyzer(cornersDir);\n\n    const availableLaps = loader.listAvailableLaps();\n    const lapAInfo = availableLaps.find(l => l.lapNumber === parseInt(currentLap));\n    const lapBInfo = availableLaps.find(l => l.lapNumber === parseInt(referenceLap));\n\n    if (!lapAInfo || !lapBInfo) {\n      return NextResponse.json({ error: 'Lap not found' }, { status: 404 });\n    }\n\n    const lapAMetadata = JSON.parse(fs.readFileSync(lapAInfo.filePath.replace('.csv', '.json'), 'utf-8'));\n    const trackName = lapAMetadata.trackName || 'Unknown';\n\n    const rawLapA = loader.loadLap(lapAInfo.filePath);\n    const rawLapB = loader.loadLap(lapBInfo.filePath);\n\n    const normalizedA = normalizer.normalize(rawLapA);\n    const normalizedB = normalizer.normalize(rawLapB);\n\n    const aligned = aligner.alignLaps(normalizedA, normalizedB);\n    const analysis = sectorAnalyzer.analyzeSectors(aligned, trackName);\n\n    const sectors = analysis.sectors.map((sector: any) => ({\n      sector: sector.sectorNumber,\n      current: sector.lapA.time,\n      reference: sector.lapB.time,\n      delta: sector.timeDelta,\n    }));\n\n    const totalCurrent = sectors.reduce((sum, s) => sum + s.current, 0);\n    const totalRef = sectors.reduce((sum, s) => sum + s.reference, 0);\n    const totalDelta = totalCurrent - totalRef;\n\n    return NextResponse.json({\n      sectors,\n      total: {\n        current: totalCurrent,\n        reference: totalRef,\n        delta: totalDelta,\n      },\n      metadata: {\n        currentLap: parseInt(currentLap),\n        referenceLap: parseInt(referenceLap),\n        track: trackName,\n      },\n    });\n  } catch (error) {\n    console.error('Error generating sector times:', error);\n    return NextResponse.json(\n      { error: 'Failed to generate sector times', details: String(error) },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAMO,eAAe,IAAI,OAAgB;IACxC,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,aAAa,aAAa,GAAG,CAAC;QACpC,MAAM,eAAe,aAAa,GAAG,CAAC;QAEtC,IAAI,CAAC,cAAc,CAAC,cAAc;YAChC,OAAO,iLAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAyB,GAClC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,UAAU,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,MAAM;QAC/C,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,MAAM;QAElD,MAAM,SAAS,IAAI,UAAU;QAC7B,MAAM,aAAa,IAAI,cAAc;YAAE,YAAY;QAAI;QACvD,MAAM,UAAU,IAAI;QACpB,MAAM,iBAAiB,IAAI,eAAe;QAE1C,MAAM,gBAAgB,OAAO,iBAAiB;QAC9C,MAAM,WAAW,cAAc,IAAI,CAAC,CAAA,IAAK,EAAE,SAAS,KAAK,SAAS;QAClE,MAAM,WAAW,cAAc,IAAI,CAAC,CAAA,IAAK,EAAE,SAAS,KAAK,SAAS;QAElE,IAAI,CAAC,YAAY,CAAC,UAAU;YAC1B,OAAO,iLAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgB,GAAG;gBAAE,QAAQ;YAAI;QACrE;QAEA,MAAM,eAAe,KAAK,KAAK,CAAC,wGAAE,CAAC,YAAY,CAAC,SAAS,QAAQ,CAAC,OAAO,CAAC,QAAQ,UAAU;QAC5F,MAAM,YAAY,aAAa,SAAS,IAAI;QAE5C,MAAM,UAAU,OAAO,OAAO,CAAC,SAAS,QAAQ;QAChD,MAAM,UAAU,OAAO,OAAO,CAAC,SAAS,QAAQ;QAEhD,MAAM,cAAc,WAAW,SAAS,CAAC;QACzC,MAAM,cAAc,WAAW,SAAS,CAAC;QAEzC,MAAM,UAAU,QAAQ,SAAS,CAAC,aAAa;QAC/C,MAAM,WAAW,eAAe,cAAc,CAAC,SAAS;QAExD,MAAM,UAAU,SAAS,OAAO,CAAC,GAAG,CAAC,CAAC,SAAgB,CAAC;gBACrD,QAAQ,OAAO,YAAY;gBAC3B,SAAS,OAAO,IAAI,CAAC,IAAI;gBACzB,WAAW,OAAO,IAAI,CAAC,IAAI;gBAC3B,OAAO,OAAO,SAAS;YACzB,CAAC;QAED,MAAM,eAAe,QAAQ,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,OAAO,EAAE;QACjE,MAAM,WAAW,QAAQ,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,SAAS,EAAE;QAC/D,MAAM,aAAa,eAAe;QAElC,OAAO,iLAAY,CAAC,IAAI,CAAC;YACvB;YACA,OAAO;gBACL,SAAS;gBACT,WAAW;gBACX,OAAO;YACT;YACA,UAAU;gBACR,YAAY,SAAS;gBACrB,cAAc,SAAS;gBACvB,OAAO;YACT;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kCAAkC;QAChD,OAAO,iLAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAmC,SAAS,OAAO;QAAO,GACnE;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}