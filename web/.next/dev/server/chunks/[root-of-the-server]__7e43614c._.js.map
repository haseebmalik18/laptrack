{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/haseebulhaqmalik/Desktop/lap-lens/web/app/api/insights/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { GForceAnalyzer } from '../../../../../src/analysis/gforce-analysis';\nimport { LapLoader } from '../../../../../src/analysis/lap-loader';\nimport { LapNormalizer } from '../../../../../src/analysis/lap-normalizer';\nimport { LapAligner } from '../../../../../src/analysis/lap-aligner';\nimport { CornerDatabase } from '../../../../../src/analysis/corner-database';\n\nexport async function GET(request: Request) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const currentLap = searchParams.get('current');\n    const referenceLap = searchParams.get('reference');\n\n    if (!currentLap || !referenceLap) {\n      return NextResponse.json(\n        { error: 'Missing lap parameters' },\n        { status: 400 }\n      );\n    }\n\n    // Load laps\n    const loader = new LapLoader();\n    const lapA = loader.loadLap(parseInt(currentLap));\n    const lapB = loader.loadLap(parseInt(referenceLap));\n\n    if (!lapA || !lapB) {\n      return NextResponse.json(\n        { error: 'Failed to load laps' },\n        { status: 404 }\n      );\n    }\n\n    // Normalize laps\n    const normalizer = new LapNormalizer();\n    const normalizedA = normalizer.normalize(lapA.telemetry);\n    const normalizedB = normalizer.normalize(lapB.telemetry);\n\n    // Align laps\n    const aligner = new LapAligner();\n    const aligned = aligner.align(normalizedA, normalizedB);\n\n    // Load corners\n    const cornerDb = new CornerDatabase();\n    const trackName = lapA.metadata.trackName;\n    const match = trackName.match(/\\(([^)]+)\\)/);\n    const simpleName = match ? match[1].toLowerCase() : trackName.toLowerCase();\n    const corners = cornerDb.loadCorners(simpleName);\n\n    if (!corners || corners.length === 0) {\n      return NextResponse.json(\n        { error: 'No corners database found' },\n        { status: 404 }\n      );\n    }\n\n    // Analyze G-forces and generate insights\n    const analyzer = new GForceAnalyzer();\n    const analysis = analyzer.analyzeGForces(aligned, corners);\n\n    // Transform insights into UI-friendly format\n    const insights = analysis.corners\n      .filter(corner => corner.insight && corner.insight.type !== 'neutral' && corner.insight.type !== 'faster-overall')\n      .map(corner => {\n        const insight = corner.insight!;\n\n        // Determine improvement type based on insight\n        let type = 'apex';\n        if (insight.type === 'under-braking' || insight.type === 'over-braking') {\n          type = 'braking';\n        } else if (corner.exitSpeed.delta < -5) {\n          type = 'exit';\n        }\n\n        // Generate concise title and description\n        let title = '';\n        let description = '';\n\n        switch (insight.type) {\n          case 'under-braking':\n            title = 'Brake Later';\n            const speedLoss = Math.abs(corner.apexSpeed.delta);\n            description = `${speedLoss.toFixed(0)} km/h slow at apex. ${insight.recommendation || 'Brake later'}`;\n            break;\n\n          case 'over-braking':\n            title = 'Braking Too Early';\n            description = insight.recommendation || 'Brake closer to corner';\n            break;\n\n          case 'not-using-grip':\n            title = 'More Grip Available';\n            const gDelta = Math.abs(corner.peakLateralG.delta);\n            description = `${gDelta.toFixed(1)}G left on table. Push harder through corner.`;\n            break;\n\n          case 'better-previous-corner':\n            title = 'Better Entry';\n            description = `Faster entry from T${corner.cornerNumber - 1}. Good adaptation.`;\n            break;\n\n          default:\n            title = 'Slower';\n            description = insight.message;\n        }\n\n        // Calculate potential time gain\n        const timeDelta = corner.exitDistance - corner.entryDistance;\n        const currentTime = timeDelta / Math.max(corner.apexSpeed.lapA, 1);\n        const refTime = timeDelta / Math.max(corner.apexSpeed.lapB, 1);\n        const potentialGain = Math.abs(currentTime - refTime);\n\n        return {\n          corner: corner.cornerNumber,\n          distance: corner.apexDistance, // Use apex distance for positioning\n          brakingDistance: corners[corner.cornerNumber - 1]?.brakingZone?.entryDistance || corner.entryDistance,\n          type,\n          title,\n          description,\n          potentialGain: `${potentialGain.toFixed(2)}s`,\n          confidence: insight.confidence,\n        };\n      });\n\n    return NextResponse.json({ insights });\n  } catch (error) {\n    console.error('Error generating insights:', error);\n    return NextResponse.json(\n      { error: 'Failed to generate insights', details: String(error) },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}